<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


    
<mapper namespace="query.crawler">

	 <resultMap id="selectWebPageInfoListResult" type="com.zebra.business.craw.domain.WebPageInfoBO" >
	        <result column="siteConfigSeq" 		property="siteConfigSeq" />
			<result column="pageInfoListSeq" 	property="pageInfoListSeq" />
			<result column="goodsNo" 			property="goodsNo" />
			<result column="goodsNm" 			property="goodsNm" />
			<result column="goodsPrice" 		property="goodsPrice" />
			<result column="goodsUrl" 			property="goodsUrl" />
			<result column="goodsImg" 			property="goodsImg" />
			<result column="statCd" 			property="statCd" />
			<result column="failCnt"			property="failCnt" />
			<result column="updateDt" 			property="updateDt" />
			<result column="updateNo" 			property="updateNo" />
			<result column="createDt"		 	property="createDt" />
			<result column="createNo" 			property="createNo" />
			<result column="failYn"   			property="failYn" />
	 </resultMap>
	<!-- 페이지 리스트 -->
	<select id="selectReNewPageInfoMap" resultType="java.util.HashMap" resultMap="selectWebPageInfoListResult" parameterType="com.zebra.business.craw.domain.WebPageInfoBO">
	     	SELECT /*crawler.selectreNewPageInfoMap*/  pageInfoListSeq
	     	, siteConfigSeq
	     	, goodsNo
	     	, goodsNm
	     	, goodsPrice
	     	, goodsUrl
	     	, goodsImg
	     	, statCd
	     	, failCnt
	     	, createNo
	     	, createDt
	     	, updateDt
	     	, updateNo
	     	,'Y' as failYn 
			FROM 
			page_info_list
			where  statCd != '03'
     		and failCnt &lt;= 5
			and updateDt &lt; adddate(sysdate(),-1)
			
			
			<if test="siteConfigSeq != null and siteConfigSeq != ''">
				and   siteConfigSeq =  #{siteConfigSeq} 
			</if>
			<if test="pageInfoListSeq != null and pageInfoListSeq != ''">
				and   pageInfoListSeq = #pageInfoListSeq}
			</if>	
			<if test="rowCnt != null and rowCnt != ''">
				limit #{rowCnt}
			</if>
				
	</select>
	
		<select id="selectPageInfoMap" resultType="java.util.HashMap" resultMap="selectWebPageInfoListResult" parameterType="com.zebra.business.craw.domain.WebPageInfoBO">
	     	SELECT /*crawler.selectPageInfoMap*/  pageInfoListSeq, siteConfigSeq, goodsNo, goodsNm, goodsPrice, goodsUrl, goodsImg, statCd, failCnt,   createNo, createDt, updateDt, updateNo 
					,'Y' as failYn
			FROM 
			page_info_list
			where 1=1
			and statCd != '03'
			<if test="siteConfigSeq != null and siteConfigSeq != ''">
				and   siteConfigSeq =  #{siteConfigSeq} 
			</if>
			<if test="pageInfoListSeq != null and pageInfoListSeq != ''">
				and   pageInfoListSeq = #{pageInfoListSeq}
			</if>		
	</select>
	
	
	

	<resultMap id="selectCrawConfigResult" type="com.zebra.business.craw.domain.CrawConfigBO" >
	        <result column="siteConfigSeq" property="siteConfigSeq" />
			<result column="siteNm" property="siteNm" />
			<result column="seedURL" property="seedStrURL" />
			<result column="useYn" property="useYn" />
			<result column="crawlAgent" property="crawlAgent" />
	</resultMap>
	<!-- 페이지 리스트 -->
	<select id="selectCrawConfigList" resultMap="selectCrawConfigResult" parameterType="com.zebra.business.craw.domain.CrawConfigBO">
	     	
	     	SELECT /*crawler.selectCrawConfigList*/ siteConfigSeq, siteNm, seedURL, useYn, crawlAgent ,createNo, createDt, updateDt, updateNo  
			FROM craw_config
			where 1=1
			and useYn = 'Y'
			<if test="siteConfigSeq != null and siteConfigSeq != ''">
				and siteConfigSeq =  #{siteConfigSeq} 
			</if>
			
	</select>
	
	<insert id="inserCrawConfig"  parameterType="com.zebra.business.craw.domain.CrawConfigBO">
	INSERT /*crawler.inserCrawConfig */ INTO craw_config
			(
				siteNm
				,seedURL
				,useYn
				,crawlAgent
				,createNo
				,createDt
				,updateDt
				,updateNo
			) 
		VALUES (
				#{siteNm}
				,#{seedStrURL}
				,#{useYn}
				,#{crawlAgent}
				,#{createNo}
				,#{createDt}
				,#{createDt}
				,#{createNo}
			)
	<selectKey resultType="String" order="AFTER"  keyProperty="siteConfigSeq">
        SELECT CONCAT(LAST_INSERT_ID()) as siteConfigSeq
    </selectKey>
    
	</insert>
	
	<insert id="insertPageInfoList"  parameterType="com.zebra.business.craw.domain.PageInfoListBO">
		
		INSERT /*crawler.insertPageInfoList */ INTO page_info_list
			(siteConfigSeq
			<if test="goodsNo != null and goodsNo != ''">, goodsNo</if>
			<if test="goodsNm != null and goodsNm != ''">, goodsNm</if>
			<if test="goodsPrice != null and goodsPrice != ''">, goodsPrice</if>
			, goodsUrl
			<if test="goodsImg != null and goodsImg != ''">, goodsImg</if>
			<if test="statCd != null and statCd != ''">, statCd</if>
			,createNo
			,createDt
			,updateDt
			,updateNo
			) 
		VALUES (#{siteConfigSeq}
			<if test="goodsNo != null and goodsNo != ''">, #{goodsNo}</if>
			<if test="goodsNm != null and goodsNm != ''">, #{goodsNm}</if>
			<if test="goodsPrice != null and goodsPrice != ''">,#{goodsPrice}</if>
			, #{goodsUrl}
			<if test="goodsImg != null and goodsImg != ''">, #{goodsImg}</if>
			<if test="statCd != null and statCd != ''">, #{statCd}</if>
			,#{createNo}
			,#{createDt}
			,#{createDt}
			,#{createNo}
			)
	</insert>
	
	
	<update id="updatePageInfoList"  parameterType="com.zebra.business.craw.domain.PageInfoListBO">
		UPDATE /* crawler.updatePageInfoList */ page_info_list
				SET 
					  createNo = createNo
					<if test="goodsNm != null and goodsNm != ''">		,  goodsNm = #{goodsNm}</if>	
					<if test="goodsPrice != null and goodsPrice != ''">	, goodsPrice = #{goodsPrice}</if>	
					<if test="goodsUrl != null and goodsUrl != ''">		, goodsUrl = #{goodsUrl}</if>	
					<if test="goodsImg != null and goodsImg != ''">		, goodsImg = #{goodsImg}</if>	
					<if test="statCd != null and statCd != ''">			, statCd = #{statCd}</if>	
					<if test="failCnt != null and failCnt != ''">		, failCnt = #{failCnt}</if>	
					<if test="updateDt != null and updateDt != ''">		, updateDt =  #{updateDt} </if>	
					<if test="updateNo != null and updateNo != ''">		, updateNo = #{updateNo}</if>	
			WHERE pageInfoListSeq = #{pageInfoListSeq}
	</update>
	
	
	
	<insert id="insertPageInfoListHistCopy"  parameterType="com.zebra.business.craw.domain.PageInfoListBO">
		
		INSERT /*crawler.insertPageInfoListHistCopy*/ INTO page_info_list_hist
				(siteConfigSeq, pageInfoListSeq, goodsNo, goodsNm, goodsPrice, goodsUrl, goodsImg,  statCd, failCnt, createNo, createDt, updateDt, updateNo) 
		select 
				siteConfigSeq, pageInfoListSeq, goodsNo, goodsNm, goodsPrice, goodsUrl, goodsImg, statCd, failCnt, createNo, sysdate(), updateDt, updateNo
		from page_info_list where   pageInfoListSeq = #{pageInfoListSeq}
	</insert>
	
	
	
	<insert id="insertCommonPatten" parameterType="com.zebra.business.craw.domain.ExpPattenBO">
		INSERT INTO /* crawler.insertCommonPatten */ patten_code_list
				(siteConfigSeq
				, pattenKind
				, pattenType
				, pattenStr
				, useYn
				, createNo
				, createDt
				, updateNo
				, updateDt
				) 
				VALUES (
				#{siteConfigSeq}
				, #{pattenKind}
				, #{pattenType}
				, #{pattenStr}
				, #{useYn}
				, #{createNo}
				, #{createDt}
				, #{createNo}
				, #{createDt} 
				)
	</insert>
	
	<update id="updateCommonPatten" parameterType="com.zebra.business.craw.domain.ExpPattenBO">
		update /* crawler.updateCommonPatten */ patten_code_list set updateNo = ${updateNo}
									, updateDt = ${updateDt}
									<if test=" pattenKind != null or pattenKind != ''" >, pattenKind = ${pattenKind} </if>
									<if test=" pattenType != null or pattenType != ''" >, pattenType = ${pattenType} </if>
									<if test=" useYn != null or useYn != ''" >, useYn = ${useYn}			  </if>
		where siteConfigSeq = #{siteConfigSeq}
		<if test =" pageInfoListSeq != null or pageInfoListSeq != ''" > and pageInfoListSeq = #{pageInfoListSeq} </if>
	</update>
	
	  
</mapper>

